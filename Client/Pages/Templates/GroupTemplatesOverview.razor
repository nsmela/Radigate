@page "/templates/groups/"
@attribute [Authorize]
@inject AuthenticationStateProvider AuthState
@inject ITemplateService TemplateService
@using Radigate.Client.Pages.Templates.Shared


<MudPaper MaxWidth="660px" Class="ma-2">
    <MudStack Row="true">
        <MudButton Variant="Variant.Outlined" Color="Color.Success" IconSize="Size.Small" 
            StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddGroup">Add Group </MudButton>
        <MudTextField Class="align-self-center" T="string" Label="Search" Variant="Variant.Outlined" 
            Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" />
    </MudStack>
</MudPaper>

<MudItem Class="pa-1 align-items-baseline">
        <!-- Existing Groups -->
        <MudStack Row=@true>
            <!-- New Group -->
            @if (newGroupOpen) {
                <MudCard Width="360px" Class="ma-2" Outlined="true" Style="@($"background:{Colors.BlueGrey.Darken4};")">
                    <MudCardHeader>
                        <MudTextField @bind-Value="newGroupLabel" Placeholder="New Group" DisableUnderLine="true" />
                    </MudCardHeader>
                    <MudCardContent>
                        <!-- Add Task -->
                        <MudPaper Elevation="10" Class="mb-1">
                            <MudToolBar Dense="true" DisableGutters="true" >
                                <MudMenu Icon="@Icons.Material.Filled.QuestionMark" Dense="true" >
                                    <MudMenuItem Icon="@Icons.Material.Filled.CheckBox" OnClick="@(()=> newTaskType = 0)">CheckBox</MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.ShortText" OnClick="@(()=> newTaskType = 1)">Text Field</MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.List" OnClick="@(()=> newTaskType = 2)">List</MudMenuItem>
                                </MudMenu>
                                <MudTextField T="string" @bind-Text="newTaskLabel" Variant="Variant.Text" />
                                <MudSpacer />
                                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="AddTask"/>
                            </MudToolBar>
                        </MudPaper>
                        <!-- New Tasks -->
                        @foreach(var task in newTasks){
                            <MudPaper Elevation="10" Class="mb-1">
                                <MudToolBar Dense="true" DisableGutters="true" >
                                    <MudIcon Icon="@TaskTypeExtensions.ToIcon((TaskType)task.Item2)" />
                                    <MudText Variant="Variant.Text">@task.Item1</MudText>
                                    <MudSpacer />
                                    <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" Color="Color.Error" />
                                </MudToolBar>
                            </MudPaper>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton OnClick="@(()=> {newGroupLabel = string.Empty; newGroupOpen = false;})">Cancel</MudButton>
                        <MudButton OnClick="AddGroup">Add Group</MudButton>
                    </MudCardActions>
                </MudCard>
            }
            <!-- Template List -->
            @if(isLoading){
                <MudProgressCircular Color="Color.Default" Indeterminate="true" />
            } else if(groups is null || groups.Count < 1){
                <span>@message</span>
            }else{
                @foreach (var group in groups) {
                    <GroupTemplateDisplay GroupTemplate="@group" Edit="false" />
                }
            }
        </MudStack>
    
</MudItem>
@code {
    bool isLoading = true;

    List<GroupTemplate> groups;
    string message = string.Empty;
    bool newGroupOpen { get; set; } = false;
    string newGroupLabel = string.Empty;
    List<Tuple<string, int>> newTasks { get; set; } = new();
    string newTaskLabel = string.Empty;
    int newTaskType = -1;

    protected override async Task OnInitializedAsync(){
        await GetGroupTemplates();
        isLoading = false;
    }

    private async Task GetGroupTemplates() {
        var response = await TemplateService.GetAllGroupTemplatesAsync();

        //request failed
        if (!response.Success) {
            message = response.Message;
            return;
        }

        //no groups in the database to show
        if (response.Data is null || response.Data.Count < 1) {
            message = "no entries!";
            return;
        }

        message = string.Empty;
        groups = new();
        foreach (var group in response.Data) groups.Add(group);
    }

    private async Task OpenAddGroup() => newGroupOpen = true;

    private async Task AddTask() {
        if (string.IsNullOrEmpty(newTaskLabel)) return;
        if (newTaskType < 0) return;

        newTasks.Add(new Tuple<string, int>(newTaskLabel, newTaskType));
        newTaskLabel = string.Empty;
        newTaskType = -1;
    }

    private async Task AddGroup(){
                
    }

    private async Task OnGroupChanged(TaskGroup group) {
    }
}
